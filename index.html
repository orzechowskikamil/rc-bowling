<html>
<head>
    <meta charset="utf-8">
    <title>Babylon - Basic scene</title>
    <style>
        html, body {
            overflow: hidden;
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
        }

        #babylon-canvas {
            width: 100%;
            height: 100%;
            touch-action: none;
        }
    </style>
    <script src="babylon.min.js"></script>
</head>
<body>
<canvas id="babylon-canvas"></canvas>
<script type="text/javascript">

    var maxBallWeight = 7.26;
    var minBallWeight = 2.20;
    var maxBallDiameter = 0.21;
    var minBallDiameter = 0.16;
    var ballWeight = maxBallWeight;
    var ballDiameter = maxBallDiameter;
    var pinHeight = 0.38;
    var pinWeight = 1.5;
    var throwForce = 50;
    var throwForceRandomness = 9;
    var trackWidth = 1;
    var trackDepth = 18;
    var sinkDepth = 15;
    var pinsPosition = {x: 0, y: 2, z: trackDepth - 2};
    var spaceBetweenPins = {x: 0.13, z: 0.20};
    var gravityVector = new BABYLON.Vector3(0, -9.81, 0);

    var sinkDef = {
        width: 0.3,
        height: 0.1,
        depth: 15
    };

    var canvas = document.querySelector("#babylon-canvas");
    var engine = new BABYLON.Engine(canvas, true);


    function createScene() {
        var scene = new BABYLON.Scene(engine);
        scene.clearColor = new BABYLON.Color3(0, 0, 0);

        var assetsManager = new BABYLON.AssetsManager(scene);


        var lightPosition = new BABYLON.Vector3(-2, 10, -4);
        var lightDirection = new BABYLON.Vector3(0, -1, 0.5);
        var lightGradient = 2;
        var lightAngleRad = 1.6;
        var light = new BABYLON.SpotLight("light", lightPosition, lightDirection, lightAngleRad, lightGradient, scene);
        light.diffuse = new BABYLON.Color3(1,1,1);
        light.specular = new BABYLON.Color3(1, 1, 1);


        var shadowGenerator = new BABYLON.ShadowGenerator(1024, light);
        var renderList = shadowGenerator.getShadowMap().renderList;
        shadowGenerator.useBlurVarianceShadowMap = true;


        var camera = new BABYLON.FreeCamera("camera1", new BABYLON.Vector3(0, 1.5, -4), scene);
        //  camera.setTarget(new BABYLON.Vector3(0, 0.3, 2));
        camera.attachControl(canvas, false);

//        var light = new BABYLON.HemisphericLight("light1", new BABYLON.Vector3(0.3, 4, 0), scene);
//        light.intensity = 0.9;



        scene.enablePhysics(gravityVector, new BABYLON.CannonJSPlugin());
//
//        var ground = BABYLON.Mesh.CreatePlane('ground', 100, scene);
//        ground.position = new BABYLON.Vector3(0, 0, 0);
//        ground.rotation = new BABYLON.Vector3(Math.PI / 2, 0, 0);
//
//
//        var groundImpostor = new BABYLON.PhysicsImpostor(ground, BABYLON.PhysicsImpostor.BoxImpostor, {
//            mass: 0,
//            friction: 0.3,
//            restitution: 1
//        }, scene);


        var meshTask = assetsManager.addMeshTask('bowling task', '', "assets/", "bs.obj");
        meshTask.onSuccess = function (result) {

            var bowlingBallMesh = result.loadedMeshes[1];
            var pinMesh = result.loadedMeshes[0];
            bowlingBallMesh.dispose();


            var floor = BABYLON.MeshBuilder.CreateBox('floor', {
                width: trackWidth,
                height: 0.2,
                depth: trackDepth
            }, scene);
            floor.position = new BABYLON.Vector3(0, 0, trackDepth / 2);
            floor.receiveShadows=true;

            var sink = BABYLON.MeshBuilder.CreateBox('sink-1', {
                width: 0.3,
                height: 0.2,
                depth: sinkDepth
            }, scene);
            sink.position = new BABYLON.Vector3(0.3 / 2 + trackWidth / 2, -0.1, sinkDepth / 2);

            var wsink = BABYLON.MeshBuilder.CreateBox('wsink-1', {
                width: 0.3,
                height: 0.2,
                depth: sinkDepth
            }, scene);
            wsink.position = new BABYLON.Vector3(0.3 / 2 + trackWidth / 2 + 0.3, 0, sinkDepth / 2);


            var sink2 = BABYLON.MeshBuilder.CreateBox('sink-2', {
                width: 0.3,
                height: 0.2,
                depth: sinkDepth
            }, scene);
            sink2.position = new BABYLON.Vector3(-1 * (0.3 / 2 + trackWidth / 2), -0.1, sinkDepth / 2);


            var wsink2 = BABYLON.MeshBuilder.CreateBox('wsink-2', {
                width: 0.3,
                height: 0.2,
                depth: sinkDepth
            }, scene);
            wsink2.position = new BABYLON.Vector3(-1 * (0.3 / 2 + trackWidth / 2 + 0.3), 0, sinkDepth / 2);


            var bowlingBall = BABYLON.Mesh.CreateSphere('bowling-ball', 100, ballDiameter, scene);
            bowlingBall.position = new BABYLON.Vector3(0, 1, 0);

            renderList.push(bowlingBall);

            var modelScale = 0.012 * (pinHeight / 0.38);
            var modelScaleVector = new BABYLON.Vector3(modelScale, modelScale, modelScale);
            pinMesh.scaling = modelScaleVector;

            var bowlingBallImpostor = new BABYLON.PhysicsImpostor(bowlingBall, BABYLON.PhysicsImpostor.SphereImpostor, {
                mass: ballWeight,
                friction: 0.2,
                restitution: 0.2
            }, scene);

            var floorImpostor = new BABYLON.PhysicsImpostor(floor, BABYLON.PhysicsImpostor.BoxImpostor, {
                mass: 0,
                friction: 0.5,
                restitution: 0
            }, scene);

            var sinkImpostor = new BABYLON.PhysicsImpostor(sink, BABYLON.PhysicsImpostor.BoxImpostor, {
                mass: 0,
                friction: 0.5,
                restitution: 0
            }, scene);

            var sink2Impostor = new BABYLON.PhysicsImpostor(sink2, BABYLON.PhysicsImpostor.BoxImpostor, {
                mass: 0,
                friction: 0.5,
                restitution: 0
            }, scene);

            var wsinkImpostor = new BABYLON.PhysicsImpostor(wsink, BABYLON.PhysicsImpostor.BoxImpostor, {
                mass: 0,
                friction: 0.5,
                restitution: 0
            }, scene);

            var wsink2Impostor = new BABYLON.PhysicsImpostor(wsink2, BABYLON.PhysicsImpostor.BoxImpostor, {
                mass: 0,
                friction: 0.5,
                restitution: 0
            }, scene);


            var pinPositions = [
                {x: 0, y: 0},
                {x: -1 * spaceBetweenPins.x, y: 1 * spaceBetweenPins.z},
                {x: 1 * spaceBetweenPins.x, y: 1 * spaceBetweenPins.z},
                {x: -2 * spaceBetweenPins.x, y: 2 * spaceBetweenPins.z},
                {x: 0, y: 2 * spaceBetweenPins.z},
                {x: 2 * spaceBetweenPins.x, y: 2 * spaceBetweenPins.z},
                {x: -1 * spaceBetweenPins.x, y: 3 * spaceBetweenPins.z},
                {x: 1 * spaceBetweenPins.x, y: 3 * spaceBetweenPins.z},
                {x: 3 * spaceBetweenPins.x, y: 3 * spaceBetweenPins.z},
                {x: -3 * spaceBetweenPins.x, y: 3 * spaceBetweenPins.z},
            ];

            pinPositions.forEach(function (val, i, arr) {
                var pin = pinMesh.clone('pin-' + i);
                pin.position = new BABYLON.Vector3(val.x + pinsPosition.x, pinsPosition.y, val.y + pinsPosition.z);
                new BABYLON.PhysicsImpostor(pin, BABYLON.PhysicsImpostor.CylinderImpostor, {
                    mass: pinWeight,
                    friction: 0.1,
                    restitution: 0.05
                }, scene);

                renderList.push(pin);
            });

            pinMesh.dispose();


            setTimeout(function () {
                bowlingBallImpostor.applyImpulse(new BABYLON.Vector3(Math.random() * throwForceRandomness - throwForceRandomness / 2, 5, throwForce), bowlingBall.getAbsolutePosition());
            }, 2000);


        };

        assetsManager.onFinish = function () {
            engine.runRenderLoop(function () {
                scene.render();
            });
        };

        assetsManager.load();

        return scene;
    }

    var scene = createScene();
    var physicsEngine = scene.getPhysicsEngine();

    physicsEngine.setTimeStep(1 / 60);


    window.addEventListener("resize", function () {
        engine.resize();
    });
</script>
</body>
</html>