<html>
<head>
    <meta charset="utf-8">
    <title>Babylon - Basic scene</title>
    <style>
        html, body {
            overflow: hidden;
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
        }

        #babylon-canvas {
            width: 100%;
            height: 100%;
            touch-action: none;
        }
    </style>
    <script src="babylon.min.js"></script>
    <script type="text/javascript">
        window.rcBowling = {};
        /**
         * quick util to log value without extracting it to variable
         */
        function loog(v) {
            console.debug(v);
            return v;
        }
    </script>
    <script type="text/javascript" src="js/definitions.js"></script>
    <script type="text/javascript" src="js/track.js"></script>
    <script type="text/javascript" src="js/bowlingSet.js"></script>
    <script type="text/javascript" src="js/lights.js"></script>
</head>
<body>
<canvas id="babylon-canvas"></canvas>
<script type="text/javascript">


    var canvas = document.querySelector("#babylon-canvas");
    var engine = new BABYLON.Engine(canvas, true);
    var debug = false;
    var timeStep = 1 / 60;
    var physicsSolverIterations = 40;
    var physicsSolverTolerance = 0.001;
    var backgroundColor = new BABYLON.Color3(0, 0, 0);

    var def = window.rcBowling.definitions;
    var ballDuringThrow = false;


    function createScene() {
        var scene = new BABYLON.Scene(engine);
        if (debug) {
            scene.debugLayer.show();
        }
        scene.enablePhysics(window.rcBowling.definitions.gravityVector, new BABYLON.CannonJSPlugin());
        var physicsEngine = scene.getPhysicsEngine();
        var physicsPlugin = physicsEngine._physicsPlugin;
        var world = physicsPlugin.world;
        physicsEngine.setTimeStep(timeStep);
        world.solver.iterations = physicsSolverIterations;
        world.solver.tolerance = physicsSolverTolerance;
        scene.clearColor = backgroundColor;

        var bowlingSetLoaded = window.rcBowling.bowlingSet.addBowlingSetToScene(scene);

        Promise.all([bowlingSetLoaded]).then(function () {
            var bowlingBall = window.rcBowling.bowlingSet.bowlingBall;

            window.rcBowling.track.addTrackToScene(scene);
            window.rcBowling.lights.initLights(scene);

            var camera = new BABYLON.TargetCamera("camera", new BABYLON.Vector3(0, 1.5, -3), scene);
            camera.setTarget(new BABYLON.Vector3(0, 0.9, 2));
            camera.attachControl(canvas, false);

            window.rcBowling.lights.addToRenderShadowList(bowlingBall);
            window.rcBowling.bowlingSet.pins.forEach(function (pin) {
                window.rcBowling.lights.addToRenderShadowList(pin);
            });


            window.rcBowling.bowlingSet.floatBall();

            canvas.addEventListener('mousemove', function (e) {
                if (ballDuringThrow) {
                    return;
                }
                var xPercent = e.screenX / window.screen.width;

                window.rcBowling.bowlingSet.bowlingBall.position = new BABYLON.Vector3(
                        xPercent * def.floor.track.width - def.floor.track.width / 2,
                        def.ball.initialPosition.y,
                        def.ball.initialPosition.z
                );
            })    ;

            canvas.addEventListener('mousedown', function (e) {
                if (ballDuringThrow) {
                    return;
                }
                ballDuringThrow = true;

                var initialEvent = {x: e.screenX, y: e.screenY, timestamp: new Date().getTime()};

                var onMouseUp = function (e) {
                    canvas.removeEventListener('mouseup', onMouseUp, true);

                    var finalEvent = {x: e.screenX, y: e.screenY, timestamp: new Date().getTime()};

                    var movement = {
                        x: finalEvent.x - initialEvent.x,
                        y: finalEvent.y - initialEvent.y,
                        duration: finalEvent.timestamp - initialEvent.timestamp
                    };

                    var forceAdjustment = {x: 2, y: -0.05, z: 25};

                    var throwForceVector = new BABYLON.Vector3(
                            movement.x * forceAdjustment.x / movement.duration,
                            movement.y * forceAdjustment.y,
                            Math.abs(movement.y) * forceAdjustment.z / movement.duration
                    );
                    window.rcBowling.bowlingSet.throwBall(throwForceVector);
                };
                canvas.addEventListener('mouseup', onMouseUp, true);
            });

            engine.runRenderLoop(function () {
                scene.render();
            });
        });

        return scene;
    }

    var scene = createScene();

    window.addEventListener("resize", function () {
        engine.resize();
    });
</script>
</body>
</html>