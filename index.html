<html>
<head>
    <meta charset="utf-8">
    <title>Babylon - Basic scene</title>
    <style>
        html, body {
            overflow: hidden;
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
        }

        #babylon-canvas {
            width: 100%;
            height: 100%;
            touch-action: none;
        }
    </style>
    <script src="babylon.min.js"></script>
</head>
<body>
<canvas id="babylon-canvas"></canvas>
<script type="text/javascript">
    window.rcBowling = {};
</script>
<script type="text/javascript" src="js/definitions.js"></script>
<script type="text/javascript" src="js/track.js"></script>
<script type="text/javascript">


    var canvas = document.querySelector("#babylon-canvas");
    var engine = new BABYLON.Engine(canvas, true);


    var def = window.rcBowling.definitions;


    function createScene() {
        var scene = new BABYLON.Scene(engine);
        scene.enablePhysics(window.rcBowling.definitions.gravityVector, new BABYLON.CannonJSPlugin());
        scene.clearColor = new BABYLON.Color3(0, 0, 0);

        var assetsManager = new BABYLON.AssetsManager(scene);


        var lightPosition = new BABYLON.Vector3(-2, 10, -4);
        var lightDirection = new BABYLON.Vector3(0, -1, 0.5);
        var lightGradient = 2;
        var lightAngleRad = 1.6;
        var light = new BABYLON.SpotLight("light", lightPosition, lightDirection, lightAngleRad, lightGradient, scene);
        light.diffuse = new BABYLON.Color3(1, 1, 1);
        light.specular = new BABYLON.Color3(1, 1, 1);

        window.rcBowling.track.addTrackToScene(scene);

        var ballMaterial = new BABYLON.StandardMaterial('ball-texture', scene);
        ballMaterial.diffuseTexture = new BABYLON.Texture('assets/ball.png', scene);

        var pinMaterial = new BABYLON.StandardMaterial('pin-texture', scene);
        var pinTexture = new BABYLON.Texture('assets/pin.png', scene);
        pinTexture.uScale = 1;
        pinTexture.vScale = 1.9;
        pinMaterial.diffuseTexture = pinTexture;


        var shadowGenerator = new BABYLON.ShadowGenerator(1024, light);
        var renderList = shadowGenerator.getShadowMap().renderList;
        shadowGenerator.useBlurVarianceShadowMap = true;


        var camera = new BABYLON.FreeCamera("camera", new BABYLON.Vector3(0, 1.5, -2), scene);
        camera.setTarget(new BABYLON.Vector3(0, 0.3, 2));
        camera.attachControl(canvas, false);


        var bowlingBall = BABYLON.Mesh.CreateSphere('bowling-ball', 100, def.ball.diameter, scene);
        bowlingBall.position = new BABYLON.Vector3(0, 1, 0);
        bowlingBall.material = ballMaterial;
        bowlingBall.impostor = new BABYLON.PhysicsImpostor(bowlingBall, BABYLON.PhysicsImpostor.SphereImpostor, {
            mass: def.ball.mass,
            friction: def.ball.friction,
            restitution: def.ball.restitution
        }, scene);

        renderList.push(bowlingBall);

        var meshTask = assetsManager.addMeshTask('bowling task', '', "assets/", "bs.obj");
        meshTask.onSuccess = function (result) {
            var bowlingBallMeshFromOBJ = result.loadedMeshes[1];
            var pinMeshFromOBJ = result.loadedMeshes[0];

            bowlingBallMeshFromOBJ.dispose();

            var pinModelScaling = def.pin.modelScale * def.pin.height;
            pinMeshFromOBJ.scaling = new BABYLON.Vector3(pinModelScaling, pinModelScaling, pinModelScaling);
            pinMeshFromOBJ.material = pinMaterial;

            var pinPositions = [
                {x: 0, y: 0},
                {x: -1 * def.pin.spacing.x, y: def.pin.spacing.z},
                {x: def.pin.spacing.x, y: def.pin.spacing.z},
                {x: -2 * def.pin.spacing.x, y: 2 * def.pin.spacing.z},
                {x: 0, y: 2 * def.pin.spacing.z},
                {x: 2 * def.pin.spacing.x, y: 2 * def.pin.spacing.z},
                {x: -1 * def.pin.spacing.x, y: 3 * def.pin.spacing.z},
                {x: def.pin.spacing.x, y: 3 * def.pin.spacing.z},
                {x: 3 * def.pin.spacing.x, y: 3 * def.pin.spacing.z},
                {x: -3 * def.pin.spacing.x, y: 3 * def.pin.spacing.z},
            ];

            pinPositions.forEach(function (val, i) {
                var pinMesh = pinMeshFromOBJ.clone('pin-' + i);
                pinMesh.position = new BABYLON.Vector3(val.x + def.pin.position.x, def.pin.position.y, val.y + def.pin.position.z);
                pinMesh.impostor = new BABYLON.PhysicsImpostor(pinMesh, BABYLON.PhysicsImpostor.CylinderImpostor, {
                    mass: def.pin.mass,
                    friction: def.pin.friction,
                    restitution: def.pin.restitution,
                    nativeOptions: {
                        linearDamping: def.pin.linearDamping,
                        angularDamping: def.pin.angularDamping
                    }
                }, scene);
                renderList.push(pinMesh);
            });

            pinMeshFromOBJ.dispose();
        };

        setTimeout(function () {
            var throwForceVector = new BABYLON.Vector3(Math.random() * def.throw.randomness - def.throw.randomness / 2, 5, def.throw.force);
            bowlingBall.impostor.applyImpulse(throwForceVector, bowlingBall.getAbsolutePosition());
        }, 2000);

        assetsManager.onFinish = function () {
            engine.runRenderLoop(function () {
                scene.render();
            });
        };

        assetsManager.load();

        return scene;
    }

    var scene = createScene();
    var physicsEngine = scene.getPhysicsEngine();

    physicsEngine.setTimeStep(1 / 60);


    window.addEventListener("resize", function () {
        engine.resize();
    });
</script>
</body>
</html>