<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Remote controlled bowling - Controller</title>

    <style>
        body[data-current-screen="pairing"] #pairing {
            display: block;
        }

        body[data-current-screen="connected-to-game"] #connected-to-game {
            display: block;
        }

        #pairing {
            display: none;
            background-color: yellow;
        }

        #connected-to-game {
            display: none;
            background-color: green;
        }

    </style>

    <script>
        window.rcBowling = {};
    </script>

    <script src="lib/peer.js/peer.min.js"></script>
    <script src="js/connection.js"></script>

    <script>
        var gamePeerId = window.location.search.split('=')[1];

        var domContentLoaded = new Promise(function (resolve, reject) {
            window.document.addEventListener('DOMContentLoaded', function (e) {
                resolve();
            });
        });

        function connectToGame(peerId) {
            return window.rcBowling.connection.getPeerId().then(function () {
                return window.rcBowling.connection.connectToPeer(peerId);
            });
        }

        domContentLoaded.then(function () {
            document.body.setAttribute('data-current-screen', 'pairing');
            return connectToGame(gamePeerId);
        }).then(function () {
            window.rcBowling.connection.send({connectedToGame: true});
            document.body.setAttribute('data-current-screen', 'connected-to-game');

            window.addEventListener('devicemotion', function (e) {
                window.rcBowling.connection.send({
                    acceleration: {
                        x: e.acceleration.x,
                        y: e.acceleration.y,
                        z: e.acceleration.z
                    },
                    rotation: {
                        alpha: e.rotationRate.alpha,
                        beta: e.rotationRate.beta,
                        gamma: e.rotationRate.gamma
                    }
                });
            });

        });

    </script>
</head>
<body data-current-screen="pairing">

<div id="pairing">Pairing...</div>
<div id="connected-to-game">Connected to the game!</div>

</body>
</html>