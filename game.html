<html>
<head>
    <meta charset="utf-8">
    <title>Remote controlled bowling</title>

    <style>
        html, body {
            overflow: hidden;
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
        }

        body[data-current-screen="game"] #game {
            display: block;
        }

        body[data-current-screen="pairing"] #pairing {
            display: block;
        }

        body[data-current-screen="before-load"] #before-load {
            display: block;
        }

        #babylon-canvas {
            width: 100%;
            height: 100%;
            touch-action: none;
        }

        #game {
            display: none
        }

        #before-load {
            display: none
        }

        #pairing {
            display: none;
            background-color: lightgray;
            text-align: center;
            padding: 5%;
            height: 100%;
            width: 100%;
            -webkit-box-sizing: border-box;
            -moz-box-sizing: border-box;
            box-sizing: border-box;
        }

        #controller-page-address-qr-code {
            padding: 2%;
            background-color: lightpink;
            height: 60%;
        }

        #controller-page-address-qr-code img {
            display: inline-block !important;
        }
    </style>

    <!--Minified file is used runtime, while non minified file is kept in project for autocompletion purposes-->
    <script src="lib/babylon.js/babylon.min.js"></script>
    <script src="lib/peer.js/peer.min.js"></script>
    <script src="lib/qrcode.js/qrcode.min.js"></script>


    <script type="text/javascript">
        window.rcBowling = {};
        /**
         * quick util to log value without extracting it to variable
         */
        function loog(v) {
            console.debug(v);
            return v;
        }
    </script>

    <script src="js/definitions.js"></script>
    <script src="js/track.js"></script>
    <script src="js/bowlingSet.js"></script>
    <script src="js/lights.js"></script>
    <script src="js/game.js"></script>
    <script src="js/camera.js"></script>
    <script src="js/connection.js"></script>


    <script type="text/javascript">

        var mode = window.location.search.split('mode=')[1];
        var remoteControllerEnabled = mode == 'remote';


        function playGame() {
            var canvas = document.querySelector("#babylon-canvas");
            var engine = new BABYLON.Engine(canvas, true);
            var backgroundColor = new BABYLON.Color3(0, 0, 0);
            var def = window.rcBowling.definitions;

            function createScene() {
                var scene = new BABYLON.Scene(engine);
                if (def.debug) {
                    scene.debugLayer.show();
                }
                scene.enablePhysics(def.physics.gravityVector, new BABYLON.CannonJSPlugin());
                var physicsEngine = scene.getPhysicsEngine();
                var physicsPlugin = physicsEngine._physicsPlugin;
                var world = physicsPlugin.world;
                physicsEngine.setTimeStep(def.physics.timeStep);
                world.solver.iterations = def.physics.solverIterations;
                world.solver.tolerance = def.physics.solverTolerance;
                scene.clearColor = backgroundColor;

                var bowlingSetLoaded = window.rcBowling.bowlingSet.addBowlingSetToScene(scene);

                Promise.all([bowlingSetLoaded]).then(function () {
                    var bowlingBall = window.rcBowling.bowlingSet.bowlingBall;

                    window.rcBowling.track.addTrackToScene(scene);
                    window.rcBowling.lights.initLights(scene);
                    window.rcBowling.camera.initCamera(scene, canvas);

                    window.rcBowling.lights.addToRenderShadowList(bowlingBall);
                    window.rcBowling.bowlingSet.pins.forEach(function (pin) {
                        window.rcBowling.lights.addToRenderShadowList(pin);
                    });

                    window.rcBowling.game.startGame();

                    engine.runRenderLoop(function () {
                        scene.render();
                    });
                });

                return scene;
            }


            createScene();

            window.addEventListener("resize", function () {
                engine.resize();
            });

        }

        window.document.addEventListener('DOMContentLoaded', function (e) {


            if (remoteControllerEnabled) {
                window.document.body.setAttribute('data-current-screen', 'before-load');

                window.rcBowling.connection.getPeerId().then(function (peerId) {
                    window.document.body.setAttribute('data-current-screen', 'pairing');
                    var serverUrl = location.href.match(/(.*)\/.*\.html/)[1];

                    var controllerPageUrl = serverUrl + '/controller.html?gameid=' + peerId;

                    console.debug(controllerPageUrl);

                    window.document.getElementById('controller-page-address-url').textContent = controllerPageUrl;
                    new QRCode('controller-page-address-qr-code', {
                        text: controllerPageUrl,
                        correctLevel: QRCode.CorrectLevel.H
                    });

                    window.rcBowling.connection.listen(function (data) {
                        console.debug('received smth! ', data);
                        window.document.body.setAttribute('data-current-screen', 'game');
                        playGame();
                    });
                });
            } else {
                playGame();
            }

        });
    </script>

</head>
<body>
<div id="game">
    <canvas id="babylon-canvas"></canvas>
</div>
<div id="pairing">
    <div>Use your smartphone as a movement controller!</div>

    <div>Scan this QR code with your device...</div>
    <div id="controller-page-address-qr-code"></div>
    <div>or open this URL address on your device</div>
    <a id="controller-page-address-url"></a>
    <div>Waiting for connection...</div>
</div>
<div id="before-load">Loading...</div>
</body>
</html>