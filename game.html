<html>
<head>
    <meta charset="utf-8">
    <title>Remote controlled bowling</title>

    <style>
        html, body {
            overflow: hidden;
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
        }

        body[data-current-screen="game"] #game {
            display: block;
        }

        body[data-current-screen="pairing"] #pairing {
            display: block;
        }

        body[data-current-screen="before-load"] #before-load {
            display: block;
        }

        #babylon-canvas {
            width: 100%;
            height: 100%;
            touch-action: none;
        }

        #game {
            display: none
        }

        #before-load {
            display: none
        }

        #pairing {
            display: none;
            background-color: lightgray;
            text-align: center;
            padding: 5%;
            height: 100%;
            width: 100%;
            -webkit-box-sizing: border-box;
            -moz-box-sizing: border-box;
            box-sizing: border-box;
        }

        #controller-page-address-qr-code {
            padding: 2%;
            background-color: lightpink;
            height: 60%;
        }

        #controller-page-address-qr-code img {
            display: inline-block !important;
        }
    </style>

    <!--Minified file is used runtime, while non minified file is kept in project for autocompletion purposes-->
    <script src="lib/babylon.js/babylon.min.js"></script>
    <script src="lib/peer.js/peer.min.js"></script>
    <script src="lib/qrcode.js/qrcode.min.js"></script>


    <script type="text/javascript">
        window.rcBowling = {};
        /**
         * quick util to log value without extracting it to variable
         */
        function loog(v) {
            console.debug(v);
            return v;
        }
    </script>

    <script src="js/definitions.js"></script>
    <script src="js/track.js"></script>
    <script src="js/bowlingSet.js"></script>
    <script src="js/lights.js"></script>
    <script src="js/game.js"></script>
    <script src="js/camera.js"></script>
    <script src="js/connection.js"></script>
    <script src="js/scene.js"></script>

    <script type="text/javascript">
        var mode = window.location.search.split('mode=')[1];
        var remoteControllerEnabled = false;

        if (mode === 'remote') {
            remoteControllerEnabled = true;
        }


        var domContentLoaded = new Promise(function (resolve, reject) {
            window.document.addEventListener('DOMContentLoaded', function (e) {
                resolve();
            });
        });

        function pairWithController() {
            return new Promise(function (resolve, reject) {
                window.rcBowling.connection.getPeerId().then(function (peerId) {
                    var serverUrl = location.href.match(/(.*)\/.*\.html/)[1];
                    var controllerPageUrl = serverUrl + '/controller.html?gameid=' + peerId;

                    new QRCode('controller-page-address-qr-code', {
                        text: controllerPageUrl,
                        correctLevel: QRCode.CorrectLevel.H
                    });

                    var controllerLinkDom = window.document.getElementById('controller-page-address-url');
                    controllerLinkDom.setAttribute('href', controllerPageUrl);
                    controllerLinkDom.textContent = controllerPageUrl;

                    window.document.body.setAttribute('data-current-screen', 'pairing');

                    window.rcBowling.connection.listen(function (data) {
                        if (data.connectedToGame === true) {
                            resolve();
                        }
                    });
                });
            });
        }

        domContentLoaded.then(function () {
            window.document.body.setAttribute('data-current-screen', 'before-load');

            if (remoteControllerEnabled) {
                window.rcBowling.remote = true;

                if (typeof window.fakeAccelerometerData === 'undefined') {
                    return pairWithController();
                }
            }
        }).then(function () {
            var canvasDom = document.getElementById('babylon-canvas');
            window.document.body.setAttribute('data-current-screen', 'game');
            window.rcBowling.scene.createScene(canvasDom);
        });

    </script>

</head>
<body>
<div id="game">
    <canvas id="babylon-canvas"></canvas>
</div>
<div id="pairing">
    <div>Use your smartphone as a movement controller!</div>

    <div>Scan this QR code with your device...</div>
    <div id="controller-page-address-qr-code"></div>
    <div>or open this URL address on your device</div>
    <a id="controller-page-address-url" target="_blank"></a>
    <div>Waiting for connection...</div>
</div>
<div id="before-load">Loading...</div>
</body>
</html>