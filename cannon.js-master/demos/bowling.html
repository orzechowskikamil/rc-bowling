<!DOCTYPE html>
<html>
<head>
    <title>cannon.js - convex demo</title>
    <meta charset="utf-8">
    <link rel="stylesheet" href="css/style.css" type="text/css"/>
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
</head>
<body>
<script src="../../cannon.js"></script>
<script src="../build/cannon.demo.js"></script>
<script src="../libs/dat.gui.js"></script>
<script src="../libs/Three.js"></script>
<script src="../libs/TrackballControls.js"></script>
<script src="../libs/Detector.js"></script>
<script src="../libs/Stats.js"></script>
<script src="../libs/smoothie.js"></script>
<script>

    /**
     * Experiment for testing ConvexPolyhedrons.
     */
    var demo = new CANNON.Demo();

    function createTetra() {
        var verts = [new CANNON.Vec3(0, 0, 0),
            new CANNON.Vec3(2, 0, 0),
            new CANNON.Vec3(0, 2, 0),
            new CANNON.Vec3(0, 0, 2)];
        var offset = -0.35;
        for (var i = 0; i < verts.length; i++) {
            var v = verts[i];
            v.x += offset;
            v.y += offset;
            v.z += offset;
        }
        return new CANNON.ConvexPolyhedron(verts,
                [
                    [0, 3, 2], // -x
                    [0, 1, 3], // -y
                    [0, 2, 1], // -z
                    [1, 2, 3], // +xyz
                ]);
    }

    function createBoxPolyhedron(size) {
        size = size || 1;
        var box = new CANNON.Box(new CANNON.Vec3(size, size, size));
        return box.convexPolyhedronRepresentation;
    }

    // Various shapes
    demo.addScene("various", function () {
        var world = setupWorld(demo);

        function addCylinder(x, y) {
// ConvexPolyhedron box shape
            var size = 0.5;
            var convexShape = createBoxPolyhedron(size);
            var mass = 0.005;
            var boxbody = new CANNON.Body({mass: mass});

            // ConvexPolyhedron cylinder shape
            var num = 20;
            var verts = [];
            var normals = [];
            var faces = [];
            var bottomface = [];
            var topface = [];
            var L = 2, R = 0.5;
            var cylinderShape = new CANNON.Cylinder(R, R, L, num);
            var cylinderBody = new CANNON.Body({mass: mass});
            cylinderBody.addShape(cylinderShape);
            cylinderBody.position.set(x, y, size * 4 + 1);
            cylinderBody.quaternion.setFromAxisAngle(new CANNON.Vec3(0, 1, 0), Math.PI / 1);
            world.addBody(cylinderBody);
            demo.addVisual(cylinderBody);
        }


        var positions = [
            {x: -3, y: -11},
            {x: -1.5, y: -11},
            {x: -0, y: -11},
            {x: 1.5, y: -11},
            {x: -2, y: -9.5},
            {x: -0.75, y: -9.5},
            {x: 0.75, y: -9.5},
            {x: -1.25, y: -8},
            {x: 0.25, y: -8},
            {x: -0.25, y: -6.5}
        ];

        positions.forEach(function (position) {
            addCylinder(position.x, position.y);
        });


        var shape = new CANNON.Sphere(1.5);
        var body = new CANNON.Body({
            mass: 20,
            position: new CANNON.Vec3(0, 10,3)
        });
        body.addShape(shape);
        body.linearDamping = body.angularDamping = 0.001;
        world.addBody(body);
        demo.addVisual(body);


        setTimeout(function() {
            // Add an impulse to the center
            var worldPoint = new CANNON.Vec3(0, 0.2, 0);
            var impulse = new CANNON.Vec3(1000*Math.random()-500, -3000, 0);
            body.applyImpulse(impulse, worldPoint);
        },3000);

    });


    function setupWorld(demo) {
        var world = demo.getWorld();
        world.gravity.set(0, 0, -30);
        world.broadphase = new CANNON.NaiveBroadphase();
        world.solver.iterations = 10;

        world.defaultContactMaterial.contactEquationStiffness = 5e6;
        world.defaultContactMaterial.contactEquationRelaxation = 3;

        // ground plane
        var n = new CANNON.Vec3(0, 0, 1);
        n.normalize();
        var groundShape = new CANNON.Plane(n);
        var groundBody = new CANNON.Body({mass: 0});
        groundBody.addShape(groundShape);
        groundBody.position.set(-10, 0, 0);
        world.addBody(groundBody);
        demo.addVisual(groundBody);

        return world;
    }


    demo.start();

</script>
</body>
</html>
